#!/usr/bin/env ruby

$:.unshift File.dirname(__FILE__)

require 'optparse'
require 'functions'
require 'probe'
require 'gather_cmd'
require 'delete_cmd'


OptionParser.new do |opts|
  opts.banner = "Usage: scythe [options]"

  opts.on("-g", 
          "--gather <project-directory>", 
          "gather probes from source code directory") do |dir|
    GatherCommand.new(dir, STDOUT, STDERR).run
  end


  opts.on("-d",
          "--delete <probe-name>",
          "delete a probe") do |probe_name|
            DeleteCommand.new(probe_name, STDOUT, STDERR).run
  end
          
  opts.on("-s [secs | h]",
          "--status [secs | hours]",
          "shows the elapsed time since the last call for each probe (in days).",
          "secs: show time in seconds", 
          "hours: show time in hours") do |format|


    format ||= ""

    unless probe_env_var && File.directory?(probe_env_var)
      STDERR.puts "scythe: environment variable SCYTHE_PROBE_DIR not set"
      exit(1)
    end

    unless ["secs", "hours", "days", ""].include?(format)
      STDERR.puts "scythe: #{format} is an invalid format for -s"
      exit(1)
    end


    now = Time.now.to_i

    probes = get_probes(probe_dir) 

    probes.map {|probe| [probe.name, probe.silent?(now, reporting_interval(format))]}
          .sort_by {|name, elapsed| [-elapsed, name] }
          .each do |name, elapsed|
            puts "%-30s %6d" % [name, elapsed]
          end
    
  end

end.parse!




